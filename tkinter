import tkinter as tk
from tkinter import messagebox
import pyodbc

# ===== SQL CONNECTION =====
conn = pyodbc.connect(
    "DRIVER={ODBC Driver 18 for SQL Server};"
    "SERVER=DESKTOP-F31UMBQ\\SQLEXPRESS;"
    "DATABASE=master;"
    "Trusted_Connection=yes;"
    "TrustServerCertificate=yes;"
)

cursor = conn.cursor()

# Create table if it doesn't exist
cursor.execute("""
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='students' AND xtype='U')
BEGIN
    CREATE TABLE students(
        id INT IDENTITY(1,1) PRIMARY KEY,
        name VARCHAR(50),
        age INT,
        grade NVARCHAR(10)
    )
END
""")
conn.commit()


# ===== FUNCTIONS =====
def add_student():
    name = entry_name.get()
    age = entry_age.get()
    grade = entry_grade.get()

    if not name or not age or not grade:
        messagebox.showerror("Error", "All fields are required!")
        return

    cursor.execute(
        "INSERT INTO students(name, age, grade) VALUES (?, ?, ?)",
        (name, age, grade)
    )
    conn.commit()
    messagebox.showinfo("Done", "Student Added!")

    entry_name.delete(0, tk.END)
    entry_age.delete(0, tk.END)
    entry_grade.delete(0, tk.END)


def view_students():
    win = tk.Toplevel(root)
    win.title("Students")

    cursor.execute("SELECT * FROM students")
    data = cursor.fetchall()

    txt = tk.Text(win, width=40, height=15)
    txt.pack()

    for d in data:
        txt.insert(tk.END, f"{d}\n")


def update_student():
    win = tk.Toplevel(root)
    win.title("Update Student")

    tk.Label(win, text="Enter Student ID").pack()
    id_e = tk.Entry(win)
    id_e.pack()

    def load():
        sid = id_e.get()
        cursor.execute("SELECT * FROM students WHERE id=?", (sid,))
        d = cursor.fetchone()

        if not d:
            messagebox.showerror("Error", "Student not found!")
            return

        edit = tk.Toplevel(win)
        edit.title("Edit Student")

        tk.Label(edit, text="Name").pack()
        n = tk.Entry(edit)
        n.pack()
        n.insert(0, d[1])

        tk.Label(edit, text="Age").pack()
        a = tk.Entry(edit)
        a.pack()
        a.insert(0, d[2])

        tk.Label(edit, text="Grade").pack()
        g = tk.Entry(edit)
        g.pack()
        g.insert(0, d[3])

        def save():
            cursor.execute(
                "UPDATE students SET name=?, age=?, grade=? WHERE id=?",
                (n.get(), a.get(), g.get(), sid)
            )
            conn.commit()
            messagebox.showinfo("Done", "Student Updated!")
            edit.destroy()

        tk.Button(edit, text="Save", command=save).pack()

    tk.Button(win, text="Search", command=load).pack()


def delete_student():
    win = tk.Toplevel(root)
    win.title("Delete Student")

    tk.Label(win, text="Enter Student ID").pack()
    id_e = tk.Entry(win)
    id_e.pack()

    def delete():
        cursor.execute("DELETE FROM students WHERE id=?", (id_e.get(),))
        conn.commit()
        messagebox.showinfo("Done", "Student Deleted!")

    tk.Button(win, text="Delete", command=delete).pack()


# ===== MAIN WINDOW =====
root = tk.Tk()
root.title("Student System")
root.geometry("300x350")

tk.Label(root, text="Name").pack()
entry_name = tk.Entry(root)
entry_name.pack()

tk.Label(root, text="Age").pack()
entry_age = tk.Entry(root)
entry_age.pack()

tk.Label(root, text="Grade").pack()
entry_grade = tk.Entry(root)
entry_grade.pack()

tk.Button(root, text="Add", width=20, command=add_student).pack(pady=5)
tk.Button(root, text="View", width=20, command=view_students).pack(pady=5)
tk.Button(root, text="Update", width=20, command=update_student).pack(pady=5)
tk.Button(root, text="Delete", width=20, command=delete_student).pack(pady=5)

root.mainloop()
